name: Update deps hash

on:
  pull_request_target:
    branches:
      - main

jobs:
  update-hash:
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.head.repo.owner.login == 'scala-steward' }}
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
    - uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31.9.0
    - uses: cachix/cachix-action@3ba601ff5bbb07c7220846facfa2cd81eeee15a1 # v16
      with:
        name: cbley
        extraPullNames: pre-commit-hooks
    - name: Update fixed output hash
      run: |
        outputHash=$( nix eval --raw '.#scalals.dependencies.outputHash' )
        sed -i'' -e "s,$outputHash,," flake.nix
        if output=$( nix build --no-link --print-build-logs '.#scalals.dependencies' 2>&1 ); then
           echo "command succeeded unexpectedly." >&2
           exit 1
        fi
        if [[ "$output" != *'error: hash mismatch in fixed-output derivation'* ]]; then
           echo "build problem: $output" >&2 ; exit 1
        fi
        git restore flake.nix
        got=$( sed -ne 's,.*got: *\([^ ]*\),\1,p' <<< "$output" )
        sed -i'' -e "s,$outputHash,$got," flake.nix
        git diff
    - name: Push changes
      uses: devops-infra/action-commit-push@f01d24007c469639f252dc88109ef96bfbff33db # v1.1.0
      with:
        amend: true
        force: true
        github_token: "${{ secrets.PR_TOKEN }}"
